name: Tests

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
    types:
      - opened
      - reopened
      - synchronize
      - ready_for_review

permissions:
  pull-requests: write
  checks: write

concurrency:
  group: gh-pr-tests-${{ github.head_ref || github.event.pull_request.head.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: 22

jobs:
  vitest:
    name: ðŸ§ª Vitest
    if: github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: ðŸ›Ž Checkout
        uses: actions/checkout@v5

      - name: ðŸ— Setup node
        uses: actions/setup-node@v5
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: ðŸ‘¨ðŸ»â€ðŸ’» Install dependencies
        run: |
          npm ci --prefer-offline --no-audit
          npm i vitest-ctrf-json-reporter --no-save

      - name: ðŸ§ª Run Vitest
        run: npm run test:unit:ci
        env:
          CI: true

      - name: ðŸ§¹ Clean CTRF Report
        run: sed -i 's|"test/vitest/__tests__/|"vitest/|g' ./vitest-ctrf/report.json

      - name: ðŸ“¤ Upload artifacts - CTRF Report
        uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: ctrf-report-vitest
          path: ./vitest-ctrf/report.json
          retention-days: 1

  playwright:
    name: ðŸ§ª Playwright
    if: github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: ðŸ›Ž Checkout
        uses: actions/checkout@v5

      - name: ðŸ— Setup node
        uses: actions/setup-node@v5
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: ðŸ‘¨ðŸ»â€ðŸ’» Install dependencies
        run: |
          npm ci --prefer-offline --no-audit
          npm i playwright-ctrf-json-reporter --no-save

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        id: cache-playwright
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            playwright-${{ runner.os }}-

      - name: ðŸ› ï¸ Playwright - Install Browsers
        run: npx playwright install --with-deps

      - name: ðŸ§ª Playwright - Run tests
        run: npm run test:playwright:ci

      - name: ðŸ§¹ Clean CTRF Report
        run: sed -i 's|"${{GITHUB_WORKSPACE}}/test/playwright/__tests__/|"playwright/|g' ./test/playwright/results/ctrf/playwright.json

      - name: ðŸ“¤ Upload artifacts - CTRF Report
        uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: ctrf-report-playwright
          path: test/playwright/results/ctrf/playwright.json
          retention-days: 1

      - name: ðŸ“¤ Upload artifacts - Playwright Report
        uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: playwright-report
          path: test/playwright/results/html/index.html

      - name: ðŸ“¤ Upload artifacts - Screenshots and Videos
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: Screenshots
          path: test/playwright/results/tests
          if-no-files-found: ignore

  report:
    name: ðŸ“¤ Publish Report
    runs-on: ubuntu-latest
    needs: [playwright, vitest]
    if: >
      always() && (
        contains(fromJson('["success", "failure"]'), needs.playwright.result) ||
        contains(fromJson('["success", "failure"]'), needs.vitest.result)
      )
    steps:
      - name: ðŸ“¥ Download CTRF Reports
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          pattern: ctrf-report-*
          path: ./ctrf

      - name: ðŸ“‹ Create CTRF Test Summary
        uses: ctrf-io/github-test-reporter@v1
        if: always() && !cancelled()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          report-path: ./ctrf/**/*.json
          summary: true
          summary-report: true
          suite-folded-report: true
          status-check: true
          status-check-name: 'Tests'

      - name: ðŸ’¬ Create CTRF Test Summary Comment
        uses: ctrf-io/github-test-reporter@v1
        if: always() && !cancelled()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          report-path: ./ctrf/**/*.json
          pull-request-report: true
          failed-folded-report: true
          skipped-report: true
          report-order: 'pull-request-report,failed-folded-report,skipped-report'
          pull-request: true
          update-comment: true
          overwrite-comment: true
          comment-tag: '${{ github.workflow }}-${{ github.job }}'
